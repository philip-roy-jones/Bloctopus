server {
    listen 80;

    # ========================
    # üîê Internal Auth Endpoint
    # ========================
    location = /_auth_validate {
        internal;
        proxy_pass              http://auth-service:1111/api/auth/validate;
        proxy_set_header        X-Auth-Token $auth_token;
        proxy_set_header        X-Internal-Request true;
        proxy_pass_request_body off;
        proxy_set_header        Content-Length "";
    }

    # ========================
    # ‚úÖ Public Routes
    # ========================

    ## Health check
    location /ping {
        return 200 "pong";
    }

    location /debug {
            default_type text/plain;
            return 200 "
                http_cookie:      [$http_cookie]
                cookie_token:     [$cookie_token]

                http_authorization: [$http_authorization]
                header_token:      [$header_token]

                auth_token:       [$auth_token]
                ";
    }

    ## Auth service (handles its own validation)
    location /api/auth/ {
        proxy_pass http://auth-service:1111;
        proxy_set_header X-Internal-Request true;
        proxy_set_header Host         $host;
        proxy_set_header X-Real-IP    $remote_addr;
    }

    # ========================
    # üîí Authenticated Routes
    # ========================

    ## All authenticated routes except /auth
    location ~ ^/api/(tasks|categories)/ {
        auth_request       /_auth_validate;
        auth_request_set   $user_id  $upstream_http_x_user_id;
        proxy_set_header   X-User-ID $user_id;
        proxy_set_header   X-Internal-Request true;
        proxy_set_header   Host      $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_pass         http://tasks-service:2222;
    }

    ## Suggestions service
    location ~ ^/api/suggestions/ {
        auth_request       /_auth_validate;
        auth_request_set   $user_id  $upstream_http_x_user_id;
        proxy_set_header   X-User-ID $user_id;
        proxy_set_header   X-Internal-Request true;
        proxy_set_header   Host      $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_pass         http://suggestions-service:4444;
    }

    # ========================
    # ‚ùå Custom Error Routes
    # ========================
    location @unauth {
        add_header Content-Type application/json;
        return 401 '{"message":"Unauthorized"}';
    }

    location @forbid {
        add_header Content-Type application/json;
        return 403 '{"message":"Forbidden"}';
    }
}
