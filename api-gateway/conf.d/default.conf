server {
    listen 80;

    # ========================
    # 🔐 Token Extraction
    # ========================
    set $auth_token "";

    if ($http_cookie ~* "sessionCookie=([^;]+)") {
        set $auth_token $1;
    }

    if ($http_authorization ~* "Bearer (.+)") {
        set $auth_token $1;
    }

    # ========================
    # 🔐 Internal Auth Endpoint
    # ========================
    location = /_auth_validate {
        internal;
        proxy_pass              http://host.docker.internal:1111/api/auth/validate;
        proxy_set_header        X-Auth-Token $auth_token;
        proxy_set_header        X-Internal-Request true;
        proxy_pass_request_body off;
        proxy_set_header        Content-Length "";
    }

    # ========================
    # ✅ Public Routes
    # ========================

    ## Health check
    location /ping {
        return 200 "pong";
    }

    ## Auth service (handles its own validation)
    location /api/auth/ {
        proxy_pass http://host.docker.internal:1111;
        proxy_set_header Host         $host;
        proxy_set_header X-Real-IP    $remote_addr;
    }

    # ========================
    # 🔒 Authenticated Routes
    # ========================

    ## All authenticated routes except /auth
    location /api/tasks/ {
        auth_request       /_auth_validate;
        auth_request_set   $user_id  $upstream_http_x_user_id;
        proxy_set_header   X-User-ID $user_id;
        proxy_set_header   X-Internal-Request true;
        proxy_set_header   Host      $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_pass         http://host.docker.internal:2222;
    }

    # ========================
    # ❌ Custom Error Routes
    # ========================
    location @unauth {
        add_header Content-Type application/json;
        return 401 '{"message":"Unauthorized"}';
    }

    location @forbid {
        add_header Content-Type application/json;
        return 403 '{"message":"Forbidden"}';
    }
}
